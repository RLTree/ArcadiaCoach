<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arcadia Coach ChatKit</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: inherit;
    }
    #chatkit-root {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="chatkit-root"></div>
  <script type="module">
    console.debug("[ArcadiaChatKit] bootstrap starting");
    const inlineModuleBase64 = "%CHATKIT_INLINE_MODULE%";
    const ARCADIA_BRAND = Object.freeze({
      primary: "#277ACC",
      onPrimary: "#F7FAFF",
      surfaceLight: "#F8FAFC",
      surfaceDark: "#0F172A"
    });
    const ARCADIA_STARTER_PROMPTS = Object.freeze([
      {
        icon: "rocket",
        label: "Plan a focus sprint",
        prompt: "Design a five-day Arcadia focus sprint on reinforcement learning fundamentals."
      },
      {
        icon: "circle-question",
        label: "Catch me up",
        prompt: "Summarize what I covered in my last Arcadia Coach lesson."
      },
      {
        icon: "chart-line",
        label: "Track my milestones",
        prompt: "Review my milestone progress and suggest the next skill checkpoint."
      },
      {
        icon: "lightbulb",
        label: "Teach a concept",
        prompt: "Explain transformers like you're coaching me through an interview warm-up."
      },
      {
        icon: "pen-to-square",
        label: "Quiz me quickly",
        prompt: "Create a five-question quiz to check recall on attention mechanisms."
      }
    ]);
    const ARCADIA_COMPOSER_TOOLS = Object.freeze([
      {
        id: "toggle_web",
        label: "Web",
        shortLabel: "Web",
        icon: "globe",
        pinned: true,
        tooltip: "Let Arcadia Coach pull in fresh web context when needed."
      },
      {
        id: "toggle_tone",
        label: "Tone",
        shortLabel: "Tone",
        icon: "sparkles",
        pinned: false,
        tooltip: "Switch between mentor and instructor tone."
      },
      {
        id: "upload_materials",
        label: "Upload",
        shortLabel: "Files",
        icon: "paperclip",
        pinned: true,
        tooltip: "Attach study notes or reference PDFs."
      }
    ]);
    const ARCADIA_MODEL_OPTIONS = Object.freeze([
      {
        id: "gpt-5",
        label: "Arcadia Coach",
        description: "Balanced depth and reasoning",
        default: true
      },
      {
        id: "gpt-5-codex",
        label: "Arcadia Code Mentor",
        description: "Optimized for code walkthroughs"
      },
      {
        id: "gpt-4.1-mini",
        label: "Arcadia Sprint",
        description: "Fast drafts when you're iterating"
      },
      {
        id: "o4-mini",
        label: "Arcadia Lite",
        description: "Cost-efficient follow-ups"
      }
    ]);

    function detectColorScheme() {
      try {
        return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      } catch (_) {
        return "light";
      }
    }

    function buildThemeOptions() {
      const colorScheme = detectColorScheme();
      return {
        colorScheme,
        color: {
          grayscale: {
            hue: 215,
            tint: 6,
            shade: colorScheme === "dark" ? -1 : -4
          },
          accent: {
            primary: colorScheme === "dark" ? ARCADIA_BRAND.onPrimary : ARCADIA_BRAND.primary,
            level: 1
          }
        },
        radius: "round",
        typography: {
          baseSize: 16,
          fontFamily: "\"SF Pro Display\",\"SF Pro Text\",-apple-system,BlinkMacSystemFont,\"Segoe UI\",sans-serif",
          fontFamilyMono: "SFMono-Regular,ui-monospace,Menlo,Monaco,Consolas,\"Liberation Mono\",\"Courier New\",monospace"
        }
      };
    }

    function buildComposerOptions(config) {
      const allowUploads = Boolean(config?.uploadURL);
      return {
        placeholder: "Tell Arcadia Coach what you want to focus on todayâ€¦",
        attachments: {
          enabled: allowUploads,
          maxCount: allowUploads ? 5 : 0,
          maxSize: allowUploads ? 10 * 1024 * 1024 : 0
        },
        tools: ARCADIA_COMPOSER_TOOLS,
        models: ARCADIA_MODEL_OPTIONS
      };
    }

    function buildStartScreenOptions() {
      return {
        greeting: "Arcadia Coach is ready to guide your next learning sprint.",
        prompts: ARCADIA_STARTER_PROMPTS
      };
    }

    function buildHeaderOptions() {
      return {
        enabled: true,
        avatar: { type: "emoji", value: "ðŸ§­" },
        title: "Arcadia Coach",
        subtitle: "Personalized AI learning companion"
      };
    }

    async function injectScript(src) {
      await new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = src;
        script.async = true;
        script.crossOrigin = "anonymous";
        script.addEventListener("load", resolve);
        script.addEventListener("error", (event) => {
          reject(new Error(`Failed to load script ${src}: ${event?.message ?? "unknown error"}`));
        });
        document.head.appendChild(script);
      });
    }

    let runtimeMode = "unknown";
    let moduleChatKit = null;
    let webComponentElement = null;

    async function loadChatKitLibrary() {
      const moduleCandidates = [
        "https://cdn.platform.openai.com/deployments/chatkit/chatkit.mjs",
        "https://cdn.openai.com/chatkit/latest/chatkit.mjs",
        "https://cdn.openai.com/chatkit/latest/chatkit.js"
      ];
      for (const url of moduleCandidates) {
        try {
          console.debug("[ArcadiaChatKit] attempting module import", url);
          const module = await import(url);
          if (module?.ChatKit) {
            return module.ChatKit;
          }
          if (module?.default?.ChatKit) {
            return module.default.ChatKit;
          }
          console.warn("[ArcadiaChatKit] Module import succeeded without ChatKit export", url);
        } catch (error) {
          console.warn("[ArcadiaChatKit] Module import failed", { url, error });
        }
      }

      const scriptCandidates = [
        "https://cdn.platform.openai.com/deployments/chatkit/chatkit.js",
        "https://cdn.openai.com/chatkit/latest/chatkit.js"
      ];
      for (const url of scriptCandidates) {
        try {
          console.debug("[ArcadiaChatKit] attempting script injection", url);
          await injectScript(url);
          if (window.ChatKit) {
            return window.ChatKit;
          }
          console.warn("[ArcadiaChatKit] Script loaded but window.ChatKit missing", url);
        } catch (error) {
          console.warn("[ArcadiaChatKit] Script injection failed", { url, error });
        }
      }
      return undefined;
    }

    async function loadInlineModule() {
      if (!inlineModuleBase64) {
        return undefined;
      }
      try {
        const decoded = atob(inlineModuleBase64);
        const blob = new Blob([decoded], { type: "text/javascript" });
        const objectUrl = URL.createObjectURL(blob);
        await new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = objectUrl;
          script.async = true;
          script.onload = () => {
            resolve();
            URL.revokeObjectURL(objectUrl);
            script.remove();
          };
          script.onerror = (event) => {
            reject(new Error(`Inline ChatKit script failed to load: ${event?.message ?? "unknown error"}`));
            URL.revokeObjectURL(objectUrl);
            script.remove();
          };
            document.head.appendChild(script);
        });
        if (window.ChatKit) {
          console.debug("[ArcadiaChatKit] Loaded ChatKit from inline script fallback.");
          return window.ChatKit;
        }
        if (customElements.get("openai-chatkit")) {
          console.debug("[ArcadiaChatKit] Inline script registered <openai-chatkit> web component.");
          return "component";
        }
        console.warn("[ArcadiaChatKit] Inline script executed but window.ChatKit is missing.");
      } catch (error) {
        console.error("[ArcadiaChatKit] Failed to load inline ChatKit module fallback", error);
      }
      return undefined;
    }

    async function discoverChatKitRuntime() {
      if (runtimeMode !== "unknown") {
        return runtimeMode;
      }
      const moduleRuntime = await loadChatKitLibrary();
      if (moduleRuntime) {
        runtimeMode = "module";
        moduleChatKit = moduleRuntime;
        return runtimeMode;
      }
      const inlineRuntime = await loadInlineModule();
      if (inlineRuntime && inlineRuntime !== "component") {
        runtimeMode = "module";
        moduleChatKit = inlineRuntime;
        return runtimeMode;
      }
      if (inlineRuntime === "component" || customElements.get("openai-chatkit")) {
        runtimeMode = "component";
        return runtimeMode;
      }
      runtimeMode = "none";
      return runtimeMode;
    }

    async function ensureRuntime() {
      const mode = await discoverChatKitRuntime();
      if (mode === "none") {
        console.error("[ArcadiaChatKit] Unable to load ChatKit from any known CDN endpoints.");
        window.arcadiaChatKitMount = () => {};
        throw new Error("ChatKit library failed to load.");
      }
      return mode;
    }

    const widgetBase64Raw = "%WIDGET_BASE64%";
    const widgetBase64 = widgetBase64Raw ? widgetBase64Raw.replace(/\s+/g, "") : "";
    const configBase64Raw = "%CHATKIT_CONFIG_BASE64%";
    const configBase64 = configBase64Raw ? configBase64Raw.replace(/\s+/g, "") : "";

    window.addEventListener("error", (event) => {
      console.error("[ArcadiaChatKit] window error", event?.message ?? "Unknown", event?.error);
    });
    window.addEventListener("unhandledrejection", (event) => {
      console.error("[ArcadiaChatKit] unhandled rejection", event?.reason ?? "Unknown");
    });

    function decodeWidget(base64) {
      if (!base64) return undefined;
      try {
        const json = atob(base64);
        return JSON.parse(json);
      } catch (err) {
        console.error("[ArcadiaChatKit] Failed to decode widget", err);
        return undefined;
      }
    }

    const widgetWrapper = decodeWidget(widgetBase64);
    if (widgetWrapper?.encodedWidget) {
      const decoded = decodeWidget(widgetWrapper.encodedWidget);
      console.debug('[ArcadiaChatKit] Widget wrapper decoded; embedded widget metadata', {
        widgetId: decoded?.id,
        widgetName: decoded?.name
      });
    } else if (widgetWrapper) {
      console.warn('[ArcadiaChatKit] Widget wrapper present without encodedWidget payload. Relying on streamed widgets.');
    } else {
      console.info('[ArcadiaChatKit] No bundled widget provided; waiting for server-streamed widgets.');
    }
    const initialConfig = configBase64 ? JSON.parse(atob(configBase64)) : null;
    let chatkitInstance;
    let currentConfig = initialConfig;
    let pendingUploadWidgetId = null;

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.multiple = true;
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);

    function requestFileUpload(widgetId) {
      pendingUploadWidgetId = widgetId ?? null;
      fileInput.click();
    }

    fileInput.addEventListener('change', async () => {
      const files = Array.from(fileInput.files || []);
      if (!files.length || !chatkitInstance) {
        return;
      }
      try {
        const results = [];
        for (const file of files) {
          const form = new FormData();
          form.append('file', file);
          if (currentConfig?.agentId) {
            form.append('agent_id', currentConfig.agentId);
          }
          const uploadURL = resolveUploadURL(currentConfig);
          const response = await fetch(uploadURL, {
            method: 'POST',
            body: form,
          });
          if (!response.ok) {
            throw new Error(`Upload failed (${response.status})`);
          }
          const data = await response.json();
          results.push(data);
        }
        if (results.length) {
          await chatkitInstance.sendCustomAction({
            type: 'files_uploaded',
            payload: { files: results },
          }, pendingUploadWidgetId ?? undefined);
        }
      } catch (error) {
        console.error('File upload failed', error);
      } finally {
        fileInput.value = '';
        pendingUploadWidgetId = null;
      }
    });

    function resolveUploadURL(config) {
      if (config?.uploadURL) {
        return config.uploadURL;
      }
      const base = config?.apiURL
        ? new URL(config.apiURL)
        : new URL('/chatkit', window.location.origin);
      base.pathname = '/api/chatkit/upload';
      return base.toString();
    }

    function apiOptionsFrom(config) {
      if (!config) return undefined;
      if (config.apiURL) {
        return {
          url: config.apiURL,
          domainKey: config.domainKey,
        };
      }
      if (config.token) {
        return {
          clientToken: config.token,
        };
      }
      return undefined;
    }

    function agentOptionsFrom(config) {
      const agentId = config?.agentId;
      return agentId ? { id: agentId } : undefined;
    }

    function attachDebugListeners(instance) {
      if (!instance || window.__arcadiaChatKitDebugListenersInstalled) {
        return;
      }
      window.__arcadiaChatKitDebugListenersInstalled = true;
      try {
        const events = instance.events;
        if (events && typeof events.on === "function") {
          events.on("thread.item.added", (event) => {
            console.debug("[ArcadiaChatKit] thread.item.added", event);
          });
          events.on("thread.synced", (event) => {
            console.debug("[ArcadiaChatKit] thread.synced", event);
          });
          events.on("error", (err) => {
            console.error("[ArcadiaChatKit] ChatKit instance error event", err);
          });
        } else {
          if (instance instanceof HTMLElement) {
            instance.addEventListener("chatkit.error", (event) => {
              console.error("[ArcadiaChatKit] ChatKit web component error", event.detail);
            });
            instance.addEventListener("chatkit.log", (event) => {
              console.debug("[ArcadiaChatKit] ChatKit web component log", event.detail);
            });
            instance.addEventListener("chatkit.threadItemAdded", (event) => {
              console.debug("[ArcadiaChatKit] thread.item.added", event.detail);
            });
            instance.addEventListener("chatkit.threadSynced", (event) => {
              console.debug("[ArcadiaChatKit] thread.synced", event.detail);
            });
          } else {
            console.warn("[ArcadiaChatKit] ChatKit instance did not expose events.on for debugging hooks.");
          }
        }
      } catch (err) {
        console.error("[ArcadiaChatKit] Failed to attach debug listeners", err);
      }
    }

    async function handleWidgetAction(action, widgetItem) {
      if (!chatkitInstance || !action) {
        return;
      }
      try {
        switch (action.type) {
          case 'chat.toggleWeb':
            await chatkitInstance.sendCustomAction({ type: 'toggle_web' }, widgetItem?.id);
            break;
          case 'chat.toggleTone':
            await chatkitInstance.sendCustomAction({ type: 'toggle_tone' }, widgetItem?.id);
            break;
          case 'chat.setLevel': {
            const level = action.params?.level ?? action.payload?.level;
            await chatkitInstance.sendCustomAction({
              type: 'set_level',
              payload: { level },
            }, widgetItem?.id);
            break;
          }
          case 'chat.add':
            requestFileUpload(widgetItem?.id ?? null);
            break;
          default:
            break;
        }
      } catch (error) {
        console.error('Widget action failed', error);
      }
    }

    async function handleClientTool(invocation) {
      if (!chatkitInstance || !invocation) {
        return { success: false };
      }
      const name = invocation.name ?? invocation.id ?? invocation.toolId;
      if (!name) {
        return { success: false };
      }
      try {
        switch (name) {
          case 'toggle_web':
            await chatkitInstance.sendCustomAction({ type: 'toggle_web' });
            return { success: true };
          case 'toggle_tone':
            await chatkitInstance.sendCustomAction({ type: 'toggle_tone' });
            return { success: true };
          case 'upload_materials':
            requestFileUpload(null);
            return { success: true };
          default:
            console.debug('[ArcadiaChatKit] Unhandled client tool invocation', name, invocation);
            return { success: false };
        }
      } catch (error) {
        console.error('[ArcadiaChatKit] Client tool invocation failed', { name, error });
        return { success: false };
      }
    }

    async function ensureChat(config) {
      if (!config) return;
      currentConfig = config;
      const element = document.querySelector('#chatkit-root');
      const apiOptions = apiOptionsFrom(config);
      const agent = agentOptionsFrom(config);
      if (!apiOptions) {
        console.warn('[ArcadiaChatKit] ChatKit configuration missing api options');
        return;
      }
      const mode = await ensureRuntime();
      const options = {
        api: apiOptions,
        agent,
        locale: 'en-US',
        theme: buildThemeOptions(),
        composer: buildComposerOptions(config),
        startScreen: buildStartScreenOptions(),
        header: buildHeaderOptions(),
        layout: {
          position: 'inline',
          autoFocus: false,
          showComposer: true
        },
        history: { enabled: true },
        widgets: {
          onAction: handleWidgetAction,
        },
        threadItemActions: {
          feedback: false
        },
        onClientTool: handleClientTool,
        onError: ({ error }) => {
          console.error('[ArcadiaChatKit] ChatKit surfaced error', error);
        },
        onThreadChange: ({ threadId }) => {
          console.debug('[ArcadiaChatKit] Active thread changed', threadId);
        },
        onResponseEnd: () => {
          console.debug('[ArcadiaChatKit] Response completed');
        }
      };

      if (mode === "module") {
        const ChatKit = moduleChatKit;
        if (!ChatKit) {
          console.error('[ArcadiaChatKit] Module runtime missing ChatKit export.');
          return;
        }
        if (!chatkitInstance) {
          console.debug('[ArcadiaChatKit] creating ChatKit instance', { apiOptions, agent });
          try {
            chatkitInstance = await ChatKit.create({
              element,
              ...options,
            });
          } catch (err) {
            console.error('[ArcadiaChatKit] Failed to create ChatKit instance', err);
            return;
          }
          console.debug('[ArcadiaChatKit] ChatKit instance ready', { hasWidgets: !!chatkitInstance?.widgets });
          attachDebugListeners(chatkitInstance);
        } else {
          console.debug('[ArcadiaChatKit] updating ChatKit options');
          chatkitInstance.setOptions(options);
        }
      } else if (mode === "component") {
        if (!webComponentElement) {
          console.debug('[ArcadiaChatKit] mounting <openai-chatkit> component');
          webComponentElement = document.createElement('openai-chatkit');
          webComponentElement.style.display = 'block';
          webComponentElement.style.height = '100%';
          element.innerHTML = '';
          element.appendChild(webComponentElement);
          attachDebugListeners(webComponentElement);
        }
        try {
          if (!customElements.get('openai-chatkit')) {
            await customElements.whenDefined('openai-chatkit');
          }
          webComponentElement.setOptions(options);
          chatkitInstance = webComponentElement;
        } catch (err) {
          console.error('[ArcadiaChatKit] Failed to set options on web component', err);
        }
      }
    }

    window.arcadiaChatKitMount = ensureChat;

    if (initialConfig) {
      ensureChat(initialConfig);
    }
  </script>
</body>
</html>
