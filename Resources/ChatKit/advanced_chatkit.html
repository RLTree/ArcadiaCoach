<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arcadia Coach ChatKit</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: inherit;
    }
    #chatkit-root {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="chatkit-root"></div>
  <script type="module">
    console.debug("[ArcadiaChatKit] bootstrap starting");

    async function injectScript(src) {
      await new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = src;
        script.async = true;
        script.crossOrigin = "anonymous";
        script.addEventListener("load", resolve);
        script.addEventListener("error", (event) => {
          reject(new Error(`Failed to load script ${src}: ${event?.message ?? "unknown error"}`));
        });
        document.head.appendChild(script);
      });
    }

    async function loadChatKitLibrary() {
      const moduleCandidates = [
        "https://cdn.platform.openai.com/deployments/chatkit/chatkit.mjs",
        "https://cdn.openai.com/chatkit/latest/chatkit.mjs",
        "https://cdn.openai.com/chatkit/latest/chatkit.js"
      ];
      for (const url of moduleCandidates) {
        try {
          console.debug("[ArcadiaChatKit] attempting module import", url);
          const module = await import(url);
          if (module?.ChatKit) {
            return module.ChatKit;
          }
          if (module?.default?.ChatKit) {
            return module.default.ChatKit;
          }
          console.warn("[ArcadiaChatKit] Module import succeeded without ChatKit export", url);
        } catch (error) {
          console.warn("[ArcadiaChatKit] Module import failed", { url, error });
        }
      }

      const scriptCandidates = [
        "https://cdn.platform.openai.com/deployments/chatkit/chatkit.js",
        "https://cdn.openai.com/chatkit/latest/chatkit.js"
      ];
      for (const url of scriptCandidates) {
        try {
          console.debug("[ArcadiaChatKit] attempting script injection", url);
          await injectScript(url);
          if (window.ChatKit) {
            return window.ChatKit;
          }
          console.warn("[ArcadiaChatKit] Script loaded but window.ChatKit missing", url);
        } catch (error) {
          console.warn("[ArcadiaChatKit] Script injection failed", { url, error });
        }
      }
      return undefined;
    }

    const ChatKit = await loadChatKitLibrary();
    if (!ChatKit) {
      console.error("[ArcadiaChatKit] Unable to load ChatKit from any known CDN endpoints.");
      window.arcadiaChatKitMount = () => {};
      throw new Error("ChatKit library failed to load.");
    }

    const widgetBase64Raw = "%WIDGET_BASE64%";
    const widgetBase64 = widgetBase64Raw ? widgetBase64Raw.replace(/\s+/g, "") : "";
    const configBase64Raw = "%CHATKIT_CONFIG_BASE64%";
    const configBase64 = configBase64Raw ? configBase64Raw.replace(/\s+/g, "") : "";

    window.addEventListener("error", (event) => {
      console.error("[ArcadiaChatKit] window error", event?.message ?? "Unknown", event?.error);
    });
    window.addEventListener("unhandledrejection", (event) => {
      console.error("[ArcadiaChatKit] unhandled rejection", event?.reason ?? "Unknown");
    });

    function decodeWidget(base64) {
      if (!base64) return undefined;
      try {
        const json = atob(base64);
        return JSON.parse(json);
      } catch (err) {
        console.error("[ArcadiaChatKit] Failed to decode widget", err);
        return undefined;
      }
    }

    const widgetWrapper = decodeWidget(widgetBase64);
    if (widgetWrapper?.encodedWidget) {
      const decoded = decodeWidget(widgetWrapper.encodedWidget);
      console.debug('[ArcadiaChatKit] Widget wrapper decoded; embedded widget metadata', {
        widgetId: decoded?.id,
        widgetName: decoded?.name
      });
    } else if (widgetWrapper) {
      console.warn('[ArcadiaChatKit] Widget wrapper present without encodedWidget payload. Relying on streamed widgets.');
    } else {
      console.info('[ArcadiaChatKit] No bundled widget provided; waiting for server-streamed widgets.');
    }
    const initialConfig = configBase64 ? JSON.parse(atob(configBase64)) : null;
    let chatkitInstance;
    let currentConfig = initialConfig;
    let pendingUploadWidgetId = null;

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.multiple = true;
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);

    fileInput.addEventListener('change', async () => {
      const files = Array.from(fileInput.files || []);
      if (!files.length || !chatkitInstance) {
        return;
      }
      try {
        const results = [];
        for (const file of files) {
          const form = new FormData();
          form.append('file', file);
          if (currentConfig?.agentId) {
            form.append('agent_id', currentConfig.agentId);
          }
          const uploadURL = resolveUploadURL(currentConfig);
          const response = await fetch(uploadURL, {
            method: 'POST',
            body: form,
          });
          if (!response.ok) {
            throw new Error(`Upload failed (${response.status})`);
          }
          const data = await response.json();
          results.push(data);
        }
        if (results.length) {
          await chatkitInstance.sendCustomAction({
            type: 'files_uploaded',
            payload: { files: results },
          }, pendingUploadWidgetId ?? undefined);
        }
      } catch (error) {
        console.error('File upload failed', error);
      } finally {
        fileInput.value = '';
        pendingUploadWidgetId = null;
      }
    });

    function resolveUploadURL(config) {
      if (config?.uploadURL) {
        return config.uploadURL;
      }
      const base = config?.apiURL
        ? new URL(config.apiURL)
        : new URL('/chatkit', window.location.origin);
      base.pathname = '/api/chatkit/upload';
      return base.toString();
    }

    function apiOptionsFrom(config) {
      if (!config) return undefined;
      if (config.apiURL) {
        return {
          url: config.apiURL,
          domainKey: config.domainKey,
        };
      }
      if (config.token) {
        return {
          clientToken: config.token,
        };
      }
      return undefined;
    }

    function agentOptionsFrom(config) {
      const agentId = config?.agentId;
      return agentId ? { id: agentId } : undefined;
    }

    function attachDebugListeners(instance) {
      if (!instance || window.__arcadiaChatKitDebugListenersInstalled) {
        return;
      }
      window.__arcadiaChatKitDebugListenersInstalled = true;
      try {
        const events = instance.events;
        if (events && typeof events.on === "function") {
          events.on("thread.item.added", (event) => {
            console.debug("[ArcadiaChatKit] thread.item.added", event);
          });
          events.on("thread.synced", (event) => {
            console.debug("[ArcadiaChatKit] thread.synced", event);
          });
          events.on("error", (err) => {
            console.error("[ArcadiaChatKit] ChatKit instance error event", err);
          });
        } else {
          console.warn("[ArcadiaChatKit] ChatKit instance did not expose events.on for debugging hooks.");
        }
      } catch (err) {
        console.error("[ArcadiaChatKit] Failed to attach debug listeners", err);
      }
    }

    async function handleWidgetAction(action, widgetItem) {
      if (!chatkitInstance || !action) {
        return;
      }
      try {
        switch (action.type) {
          case 'chat.toggleWeb':
            await chatkitInstance.sendCustomAction({ type: 'toggle_web' }, widgetItem?.id);
            break;
          case 'chat.toggleTone':
            await chatkitInstance.sendCustomAction({ type: 'toggle_tone' }, widgetItem?.id);
            break;
          case 'chat.setLevel': {
            const level = action.params?.level ?? action.payload?.level;
            await chatkitInstance.sendCustomAction({
              type: 'set_level',
              payload: { level },
            }, widgetItem?.id);
            break;
          }
          case 'chat.add':
            pendingUploadWidgetId = widgetItem?.id ?? null;
            fileInput.click();
            break;
          default:
            break;
        }
      } catch (error) {
        console.error('Widget action failed', error);
      }
    }

    async function ensureChat(config) {
      if (!config) return;
      currentConfig = config;
      const element = document.querySelector('#chatkit-root');
      const apiOptions = apiOptionsFrom(config);
      const agent = agentOptionsFrom(config);
      if (!apiOptions) {
        console.warn('[ArcadiaChatKit] ChatKit configuration missing api options');
        return;
      }
      if (!chatkitInstance) {
        console.debug('[ArcadiaChatKit] creating ChatKit instance', { apiOptions, agent });
        try {
          chatkitInstance = await ChatKit.create({
            element,
            api: apiOptions,
            agent,
            layout: {
              position: 'inline',
              autoFocus: false,
              showComposer: false
            },
            header: { enabled: false },
            history: { enabled: false },
            widgets: {
              onAction: handleWidgetAction,
            },
            theme: {
              mode: 'system',
              fontSize: 'md',
              borderRadius: 'xl'
            }
          });
        } catch (err) {
          console.error('[ArcadiaChatKit] Failed to create ChatKit instance', err);
          return;
        }
        console.debug('[ArcadiaChatKit] ChatKit instance ready', { hasWidgets: !!chatkitInstance?.widgets });
        attachDebugListeners(chatkitInstance);
      } else {
        console.debug('[ArcadiaChatKit] updating ChatKit options');
        chatkitInstance.setOptions({
          api: apiOptions,
          agent,
          widgets: {
            onAction: handleWidgetAction,
          },
        });
      }
    }

    window.arcadiaChatKitMount = ensureChat;

    if (initialConfig) {
      ensureChat(initialConfig);
    }
  </script>
</body>
</html>
